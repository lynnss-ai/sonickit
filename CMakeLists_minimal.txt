cmake_minimum_required(VERSION 3.16)
project(voice_new_modules_test C)

set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# 源目录
set(VOICE_SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}")

# 平台检测 - 不使用宏冲突的定义
if(WIN32)
    add_compile_definitions(_WIN32_DEFINED=1)
    set(PLATFORM_LIBS ws2_32 winmm ole32 iphlpapi)
elseif(APPLE)
    set(PLATFORM_LIBS)
elseif(UNIX)
    find_package(Threads REQUIRED)
    set(PLATFORM_LIBS Threads::Threads m dl)
endif()

# miniaudio
add_library(miniaudio STATIC ${VOICE_SOURCE_DIR}/third_party/miniaudio/miniaudio.c)
target_include_directories(miniaudio PUBLIC ${VOICE_SOURCE_DIR}/third_party/miniaudio)

# 创建一个简化的类型定义头文件用于测试
file(WRITE ${CMAKE_BINARY_DIR}/voice_types_simple.h "
#ifndef VOICE_TYPES_SIMPLE_H
#define VOICE_TYPES_SIMPLE_H

typedef enum {
    VOICE_OK = 0,
    VOICE_ERROR_INVALID_PARAM = -1,
    VOICE_ERROR_OUT_OF_MEMORY = -2,
    VOICE_ERROR_NOT_INITIALIZED = -3,
    VOICE_ERROR_NOT_FOUND = -4,
    VOICE_ERROR_NETWORK = -5,
    VOICE_ERROR_TIMEOUT = -6,
    VOICE_ERROR_NOT_IMPLEMENTED = -7
} voice_error_t;

#endif
")

# 新增模块（本次创建的）
set(NEW_MODULES_SOURCES
    ${VOICE_SOURCE_DIR}/src/dsp/effects.c
    ${VOICE_SOURCE_DIR}/src/dsp/watermark.c
    ${VOICE_SOURCE_DIR}/src/utils/diagnostics.c
    ${VOICE_SOURCE_DIR}/src/network/datachannel.c
    ${VOICE_SOURCE_DIR}/src/sip/sip_core.c
    ${VOICE_SOURCE_DIR}/src/sip/sip_ua.c
)

# 新增模块测试库
add_library(voice_new_modules STATIC ${NEW_MODULES_SOURCES})
target_include_directories(voice_new_modules PUBLIC 
    ${CMAKE_BINARY_DIR}
    ${VOICE_SOURCE_DIR}/include
    ${VOICE_SOURCE_DIR}
)
target_link_libraries(voice_new_modules PUBLIC miniaudio ${PLATFORM_LIBS})

# 简单测试程序
add_executable(test_new_modules ${VOICE_SOURCE_DIR}/tests/test_new_modules.c)
target_include_directories(test_new_modules PRIVATE ${CMAKE_BINARY_DIR})
target_link_libraries(test_new_modules voice_new_modules)
